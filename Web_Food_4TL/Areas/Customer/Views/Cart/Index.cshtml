@model List<Web_Food_4TL.Models.GioHang>

<section class="h-100 h-custom" style="background-color: #eee;">
    <div class="container h-100 py-5">
        <div class="row d-flex justify-content-center align-items-center h-100">
            <div class="col">
                <div class="card shopping-cart" style="border-radius: 15px;">
                    <div class="card-body">

                        <div class="row">
                            <!-- Cột trái: Danh sách sản phẩm -->
                            <div class="col-lg-6 px-5 py-4">
                                <h3 class="mb-5 pt-2 text-center fw-bold text-uppercase">Giỏ Hàng</h3>

                                @foreach (var item in Model)
                                {
                                    <div class="d-flex align-items-center mb-4 p-3 border rounded bg-white shadow-sm" id="item-@item.Id">
                                        <div class="flex-shrink-0">
                                            @{
                                                var anhDau = item.MonAn.AnhMonAnh?.FirstOrDefault();
                                            }

                                            @if (anhDau != null)
                                            {
                                                <img src="/uploads/monan/@anhDau.Url" class="img-fluid rounded"
                                                     style="width: 120px; height: 80px; object-fit: cover;" alt="@item.MonAn.TenMonAn" />
                                            }
                                            else
                                            {
                                                <img src="https://placehold.co/120x80/png" class="img-fluid rounded"
                                                     style="width: 120px; height: 80px; object-fit: cover;" alt="Không có ảnh" />
                                            }
                                        </div>


                                        <div class="flex-grow-1 ms-4">
                                            <h5 class="text-primary mb-1">@item.MonAn.TenMonAn</h5>
                                            <p class="fw-bold mb-2 text-danger">@string.Format("{0:N0} đ", item.MonAn.Gia)</p>

                                            <div class="d-flex align-items-center">
                                                <!-- Nút giảm số lượng -->
                                                <button onclick="giamSoLuong(@item.Id)" class="btn btn-outline-secondary btn-sm rounded-circle me-2">
                                                    <i class="fa-solid fa-minus"></i>
                                                </button>

                                                <!-- Hiển thị số lượng -->
                                                <input class="form-control text-center mx-2 fw-bold"
                                                       id="soLuong-@item.Id"
                                                       value="@item.SoLuong"
                                                       type="text"
                                                       style="width: 50px;" readonly>

                                                <!-- Nút tăng số lượng -->
                                                <button onclick="tangSoLuong(@item.Id)" class="btn btn-outline-primary btn-sm rounded-circle ms-2">
                                                    <i class="fa-solid fa-plus"></i>
                                                </button>

                                                <!-- Nút xóa món -->
                                                <button onclick="xoaMonAn(@item.Id)" class="btn btn-danger btn-sm rounded-circle ms-3">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                }


                                <hr class="mb-4" style="height: 2px; background-color: #1266f1; opacity: 1;">

                                <div class="d-flex justify-content-between px-x">
                                    <p class="fw-bold">Tổng tiền:</p>
                                    <p class="fw-bold">@string.Format("{0:N0} đ", Model.Sum(x => x.MonAn.Gia * x.SoLuong))</p>
                                </div>
                            </div>

                            <!-- Cột phải: Nhập thông tin giao hàng -->
                            <div class="col-lg-6 px-5 py-4">
                                <h3 class="mb-5 pt-2 text-center fw-bold text-uppercase">Thông tin giao hàng</h3>

                                <form id="formThanhToan" asp-area="Customer" asp-controller="VnPay" asp-action="Payment" method="post">
                                    <div class="mb-3">
                                        <label for="DiaChiGiaoHang" class="form-label">Địa chỉ giao hàng</label>
                                        <input type="text" name="DiaChiGiaoHang" id="DiaChiGiaoHang" class="form-control">
                                        <div class="invalid-feedback" id="diaChiError">Vui lòng nhập địa chỉ giao hàng.</div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="SoDienThoai" class="form-label">Số điện thoại</label>
                                        <input type="tel" name="SoDienThoai" id="SoDienThoai" class="form-control">
                                        <div class="invalid-feedback" id="soDienThoaiError">Vui lòng nhập số điện thoại hợp lệ (10-11 chữ số).</div>
                                    </div>


                                    <button type="button" class="btn btn-primary btn-block btn-lg" id="btnShowTerms">
                                        Thanh toán VNPay
                                    </button>

                                    @if (ViewBag.ErrorMessage != null)
                                    {
                                        <div id="cart-alert" class="alert alert-warning">@ViewBag.ErrorMessage</div>
                                        <script>
                                            setTimeout(function() {
                                                var alertBox = document.getElementById('cart-alert');
                                                if (alertBox) {
                                                    alertBox.style.display = 'none';
                                                }
                                            }, 3000); 
                                        </script>
                                    }
                                    <h5 class="fw-bold mt-4">
                                        <a href="/Customer" class="text-decoration-none"><i class="fas fa-angle-left me-2"></i>Quay lại mua hàng</a>
                                    </h5>
                                </form>

                            </div>

                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</section>


<!-- Modal điều khoản thanh toán -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content shadow rounded-4">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="termsModalLabel">Điều khoản thanh toán</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body" style="line-height: 1.7;">
                <p><em>Vui lòng đọc kỹ các điều khoản trước khi xác nhận thanh toán đơn hàng. Việc tiếp tục thanh toán đồng nghĩa với việc bạn đồng ý với các nội dung sau:</em></p>

                <p>Quý khách đang thực hiện thanh toán qua hệ thống đặt món trực tuyến của <strong>[FOOD-4TL]</strong>, hỗ trợ bởi <strong>cổng thanh toán VNPAY</strong>.</p>

                <p>Các thông tin cá nhân được thu thập trong quá trình thanh toán bao gồm: <strong>thông tin thẻ/tài khoản ngân hàng</strong>, <strong>tên, số điện thoại, địa chỉ giao hàng</strong> và các thông tin liên quan đến đơn hàng. Những dữ liệu này sẽ được chuyển tiếp đến <strong>VNPAY</strong> và các <strong>ngân hàng/tổ chức trung gian thanh toán</strong> nhằm mục đích xử lý giao dịch.</p>

                <p>Dữ liệu của Quý khách cũng có thể được sử dụng để: xử lý đơn hàng, xác nhận thanh toán, hỗ trợ chăm sóc khách hàng, cung cấp ưu đãi và nâng cao trải nghiệm người dùng.</p>

                <p>Chúng tôi cam kết bảo mật thông tin của Quý khách theo <a href="#">chính sách bảo vệ dữ liệu cá nhân</a> và chỉ sử dụng cho các mục đích phục vụ đơn hàng.</p>

                <p><small>(*) Theo Nghị định 13/2023/NĐ-CP ngày 17/4/2023, thông tin thẻ/tài khoản được xem là dữ liệu cá nhân nhạy cảm và sẽ được bảo mật theo đúng quy định pháp luật.</small></p>

                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="agreeTerms">
                    <label class="form-check-label" for="agreeTerms">
                        Tôi đã đọc và đồng ý với các điều khoản thanh toán.
                    </label>
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-between px-4 pb-3">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="confirmPaymentBtn" disabled>Xác nhận thanh toán</button>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const showTermsBtn = document.getElementById('btnShowTerms');
        const agreeCheckbox = document.getElementById('agreeTerms');
        const confirmBtn = document.getElementById('confirmPaymentBtn');
        const formThanhToan = document.getElementById('formThanhToan');

        const diaChiInput = document.getElementById('DiaChiGiaoHang');
        const soDienThoaiInput = document.getElementById('SoDienThoai');

        // Gỡ viền đỏ khi người dùng đang nhập lại
        diaChiInput.addEventListener('input', function() {
            diaChiInput.classList.remove('is-invalid');
        });

        soDienThoaiInput.addEventListener('input', function() {
            soDienThoaiInput.classList.remove('is-invalid');
        });

        // Khi nhấn "Thanh toán VNPay" thì kiểm tra dữ liệu trước khi mở modal
        showTermsBtn.addEventListener('click', function() {
            const diaChi = diaChiInput.value.trim();
            const soDienThoai = soDienThoaiInput.value.trim();
            const soDienThoaiPattern = /^[0-9]{10,11}$/;

            let valid = true;

            // Reset trạng thái lỗi
            diaChiInput.classList.remove('is-invalid');
            soDienThoaiInput.classList.remove('is-invalid');

            if (diaChi === '') {
                diaChiInput.classList.add('is-invalid');
                valid = false;
            }

            if (!soDienThoaiPattern.test(soDienThoai)) {
                soDienThoaiInput.classList.add('is-invalid');
                valid = false;
            }

            if (!valid) return;

            // Nếu hợp lệ thì hiện modal
            const modal = new bootstrap.Modal(document.getElementById('termsModal'));
            modal.show();
        });

        // Bật/tắt nút xác nhận trong modal
        agreeCheckbox.addEventListener('change', function() {
            confirmBtn.disabled = !this.checked;
        });

        // Khi nhấn "Xác nhận thanh toán" thì submit form
        confirmBtn.addEventListener('click', function() {
            formThanhToan.submit();
        });
    });
</script>
